!function(e){"function"==typeof define&&define.amd?define(["jquery","./grid.base"],e):e(jQuery)}(function(g){g.jgrid.extend({dbInit:function(e){return this.each(function(){"indexeddb"===e&&g(this).jqGrid("_initIndexedDB_")})},_initIndexedDB_:function(){this.each(function(){var c=this;indexedDB.databases().then(function(e){var r=indexedDB.open(c.p.dbconfig.dbname);r.onupgradeneeded=e=>{console.info("Database created: "+c.p.dbconfig.dbname)},r.onsuccess=function(e){let t=e.target.result;var r=parseInt(t.version),l=g.jgrid.getElemByAttrVal(c.p.colModel,"key",!0);async function n(i){var e=c.p.dbconfig;if("string"==typeof e.dataUrl){try{var d=await(await fetch(e.dataUrl,e.fetchOptions)).json();null!==e.reader&&(d=g.jgrid.getAccessor(d,e.reader))}catch(e){return void console.log("Error:"+e)}g.jgrid.isFunction(e.beforeInsertData)&&(d=e.beforeInsertData.call(c,d))}else Array.isArray(e.dataUrl)&&(d=e.dataUrl);c.p.dbconfig.dbversion=r+1;e=indexedDB.open(e.dbname,r+1);e.onupgradeneeded=function(e){var r=e.target.result;if(!i){var o=r.createObjectStore(c.p.dbconfig.dbtable,{keyPath:l.name});for(let e=0;e<c.p.colModel.length;e++){var t=c.p.colModel[e];t.name===l.name?o.createIndex(t.name,t.name,{unique:!0}):o.createIndex(t.name,t.name,{unique:!1})}}var n,a=e.target.transaction.objectStore(c.p.dbconfig.dbtable);a.transaction.oncomplete=function(e){},a.transaction.onerror=function(e){g.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")};for(n of d)c.p.dbconfig.isKeyInData||(n[l.name]=Math.random().toString(16).slice(2)),a.put(n);c.p.dbconfig.ready_req=!0,c.grid.populate()},e.onerror=e=>{g.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")}}if(g.isEmptyObject(l))g.jgrid.info_dialog("Warning","Missed key: No uniquie key is set in colModel. Creating table fail","Close");else if(t.objectStoreNames.contains(c.p.dbconfig.dbtable))if(c.p.dbconfig.loadIfExists||c.p.dbconfig.deleteIfExists){let r=t.transaction(c.p.dbconfig.dbtable,"readwrite").objectStore(c.p.dbconfig.dbtable),o=r.count();o.onsuccess=()=>{var e;0<o.result?c.p.dbconfig.deleteIfExists?((e=r.clear()).onsuccess=e=>{console.log("All records are cleared"),t.close(),n(!0)},e.onerror=e=>{g.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")}):c.p.dbconfig.loadIfExists?(t.close(),n(!0)):(t.close(),c.p.dbconfig.ready_req=!0,c.grid.populate()):(t.close(),n(!0))}}else t.close(),c.p.dbconfig.ready_req=!0,c.grid.populate();else t.close(),n(!1)},r.onerror=e=>{g.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")}})})},updateStorageRecord:async function(d,l){let c=this[0],s=c.p.dbconfig,e=c.p.datatype;return new Promise(function(a,i){if(Array.isArray(d)||(d=[d]),l=l||c.p.keyName,d=g.jgrid.normalizeDbData.call(c,d,c.p.colModel),"indexeddb"===e){let o=window.indexedDB.open(s.dbname);o.onsuccess=e=>{var r=o.result.transaction(s.dbtable,"readwrite"),t=(r.oncomplete=e=>{a(e),console.log("Transaction completed succefully")},r.onerror=r=>{i(r);try{g.jgrid.info_dialog.call("Error",r.target.error,"Close",{styleUI:c.p.styleUI})}catch(e){console.log(r.target.error)}},r.objectStore(s.dbtable));for(let o=0;o<d.length;o++){if(!d[o].hasOwnProperty(l)||""===d[o][l]){r.abort();break}var n=t.openCursor();n.onsuccess=e=>{var r,e=e.target.result;e&&((r=e.value)[l]===d[o][l]?(delete d[o].oper,r=Object.assign(r,d[o]),e.update(r)):e.continue())},n.onerror=e=>{console.log(e.target.error)}}}}})},addStorageRecord:async function(i,d){let l=this[0],c=l.p.dbconfig,e=l.p.datatype;return new Promise(function(n,a){if(Array.isArray(i)||(i=[i]),d=d||l.p.keyName,i=g.jgrid.normalizeDbData.call(l,i,l.p.colModel),"indexeddb"===e){let t=window.indexedDB.open(c.dbname);t.onsuccess=e=>{var r=t.result.transaction(c.dbtable,"readwrite"),o=(r.oncomplete=e=>{n(e),console.log("Transaction completed succefully")},r.onerror=r=>{a(r);try{g.jgrid.info_dialog.call("Error",r.target.error,"Close",{styleUI:l.p.styleUI})}catch(e){console.log(r.target.error)}},r.objectStore(c.dbtable));for(let e=0;e<i.length;e++)i[e].hasOwnProperty(d)&&""!==i[e][d]||(i[e][d]=Math.random().toString(16).slice(2)),o.add(i[e]).onsuccess=e=>{}}}})},deleteStorageRecord:async function(d,l){let c=this[0],s=c.p.dbconfig,e=c.p.datatype;return new Promise(function(n,a){if(Array.isArray(d)||(d=d.split(",")),l=l||c.p.keyName,"indexeddb"===e){var i=[],r={};for(let e=0;e<d.length;e++)r[l]=d[e],i.push(r);i=g.jgrid.normalizeDbData.call(c,i,c.p.colModel);let t=window.indexedDB.open(s.dbname);t.onsuccess=e=>{var r=t.result.transaction(s.dbtable,"readwrite"),o=(r.oncomplete=e=>{n(e),console.log("Transaction completed succefully")},r.onerror=r=>{a(r);try{g.jgrid.info_dialog.call("Error",r.target.error,"Close",{styleUI:c.p.styleUI})}catch(e){console.log(r.target.error)}},r.objectStore(s.dbtable));for(let r=0;r<d.length;r++)o.delete(i[r][l]).onsuccess=e=>{console.log("Deleted record: "+d[r])}}}})}})});