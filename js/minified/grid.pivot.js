!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],e):e(jQuery)}(function(Q){"use strict";Q.assocArraySize=function(e){var r,o=0;for(r in e)e.hasOwnProperty(r)&&o++;return o},Q.jgrid.extend({pivotSetup:function(H,e){var N=[],k=[],G=[],M=[],z=[],A={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},V=[],q=Q.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1},e||{});return this.each(function(){var e,p,f,d,r,o,h=this,t=H.length,n=0;function a(e,r,o){o=function(e,r){var o,t,n,a=[];if(!this||"function"!=typeof e||e instanceof RegExp)throw new TypeError;for(n=this.length,o=0;o<n;o++)if(this.hasOwnProperty(o)&&(t=this[o],e.call(r,t,o,this))){a.push(t);break}return a}.call(e,r,o);return 0<o.length?o[0]:null}function i(e,r){var o,t=0,n=!0;for(o in e)if(e.hasOwnProperty(o)){if(e[o]!=this[t]){n=!1;break}if(++t>=this.length)break}return n&&(w=r),n}function s(e,r,o,t){var n,a,i,s,l,g=r.length,u="",m=[],p=1;for(Q.isArray(o)?(i=o.length,m=o):(i=1,m[0]=o),z=[],a=(M=[]).root=0;a<i;a++){for(var f,d=[],c=0;c<g;c++){if(s="string"==typeof r[c].aggregator?r[c].aggregator:"cust",null==o)f=n=Q.trim(r[c].member)+"_"+s,m[0]=r[c].label||s+" "+Q.trim(r[c].member);else{f=o[a].replace(/\s+/g,"");try{n=1===g?u+f:u+f+"_"+s+"_"+String(c)}catch(e){}m[a]=o[a]}n=isNaN(parseInt(n,10))?n:n+" ","avg"===r[c].aggregator&&(l=-1===w?k.length+"_"+n:w+"_"+n,v[l]?v[l]++:v[l]=1,p=v[l]),t[n]=d[n]=function(e,r,o,t,n){var a;if(Q.isFunction(e))a=e.call(h,r,o,t);else switch(e){case"sum":a=parseFloat(r||0)+parseFloat(t[o]||0);break;case"count":""!==r&&null!=r||(r=0),a=t.hasOwnProperty(o)?r+1:0;break;case"min":a=""===r||null==r?parseFloat(t[o]||0):Math.min(parseFloat(r),parseFloat(t[o]||0));break;case"max":a=""===r||null==r?parseFloat(t[o]||0):Math.max(parseFloat(r),parseFloat(t[o]||0));break;case"avg":a=(parseFloat(r||0)*(n-1)+parseFloat(t[o]||0))/n}return a}(r[c].aggregator,t[n],r[c].member,e,p)}u+=o&&null!=o[a]?o[a].replace(/\s+/g,""):"",M[n]=d,z[n]=m[a]}return t}if(q.rowTotals&&0<q.yDimension.length&&(r=q.yDimension[0].dataName,q.yDimension.splice(0,0,{dataName:r}),q.yDimension[0].converter=function(){return"_r_Totals"}),p=Q.isArray(q.xDimension)?q.xDimension.length:0,f=q.yDimension.length,d=Q.isArray(q.aggregates)?q.aggregates.length:0,0===p||0===d)throw"xDimension or aggregates optiona are not set!";for(y=0;y<p;y++)o={name:q.xDimension[y].dataName,frozen:q.frozenStaticCols},null==q.xDimension[y].isGroupField&&(q.xDimension[y].isGroupField=!0),o=Q.extend(!0,o,q.xDimension[y]),N.push(o);for(var l=p-1,g={},v=[];n<t;){e=H[n];for(var u=[],m=[],c={},y=0;u[y]=Q.trim(e[q.xDimension[y].dataName]),c[q.xDimension[y].dataName]=u[y],y++,y<p;);var x,b=0,w=-1;if(x=a(k,i,u)){if(0<=w){if(b=0,1<=f){for(b=0;b<f;b++)m[b]=Q.trim(e[q.yDimension[b].dataName]),q.yDimension[b].converter&&Q.isFunction(q.yDimension[b].converter)&&(m[b]=q.yDimension[b].converter.call(this,m[b],u,m));x=s(e,q.aggregates,m,x)}else 0===f&&(x=s(e,q.aggregates,null,x));k[w]=x}}else{if(b=0,1<=f){for(b=0;b<f;b++)m[b]=Q.trim(e[q.yDimension[b].dataName]),q.yDimension[b].converter&&Q.isFunction(q.yDimension[b].converter)&&(m[b]=q.yDimension[b].converter.call(this,m[b],u,m));c=s(e,q.aggregates,m,c)}else 0===f&&(c=s(e,q.aggregates,null,c));k.push(c)}var D,F=0,O=null,j=null;for(D in M)if(M.hasOwnProperty(D)){if(0===F)g.children&&void 0!==g.children||(g={text:D,level:0,children:[],label:D}),O=g.children;else{for(j=null,y=0;y<O.length;y++)if(O[y].text===D){j=O[y];break}O=j?j.children:(O.push({children:[],text:D,level:F,fields:M[D],label:z[D]}),O[O.length-1].children)}F++}n++}v=null;var S,T=[],C=N.length,P=C;if(0<f&&(V[f-1]={useColSpanStyle:!1,groupHeaders:[]}),function e(r){var o,t,n,a,i;for(n in r)if(r.hasOwnProperty(n)){if("object"!=typeof r[n]){if("level"===n){if(void 0===T[r.level]&&(T[r.level]="",0<r.level&&-1===r.text.indexOf("_r_Totals")&&(V[r.level-1]={useColSpanStyle:!1,groupHeaders:[]})),T[r.level]!==r.text&&r.children.length&&-1===r.text.indexOf("_r_Totals")&&0<r.level){V[r.level-1].groupHeaders.push({titleText:r.label,numberOfColumns:0});var s=V[r.level-1].groupHeaders.length-1,l=0==s?P:C;if(r.level-1==(q.rowTotals?1:0)&&0<s){for(var g=0,u=0;u<s;u++)g+=V[r.level-1].groupHeaders[u].numberOfColumns;g&&(l=g+p)}N[l]&&(V[r.level-1].groupHeaders[s].startColumnName=N[l].name,V[r.level-1].groupHeaders[s].numberOfColumns=N.length-l),C=N.length}T[r.level]=r.text}if(r.level===f&&"level"===n&&0<f)if(1<d){var m=1;for(o in r.fields)r.fields.hasOwnProperty(o)&&(1===m&&V[f-1].groupHeaders.push({startColumnName:o,numberOfColumns:1,titleText:r.label||r.text}),m++);V[f-1].groupHeaders[V[f-1].groupHeaders.length-1].numberOfColumns=m-1}else V.splice(f-1,1)}if(null!=r[n]&&"object"==typeof r[n]&&e(r[n]),"level"===n&&0<r.level&&(r.level===(0===f?r.level:f)||-1!==T[r.level].indexOf("_r_Totals")))for(o in t=0,r.fields)if(r.fields.hasOwnProperty(o)){for(a in i={},q.aggregates[t])if(q.aggregates[t].hasOwnProperty(a))switch(a){case"member":case"label":case"aggregator":break;default:i[a]=q.aggregates[t][a]}1<d?(i.name=o,i.label=q.aggregates[t].label||r.label):(i.name=r.text,i.label="_r_Totals"===r.text?q.rowTotalsText:r.label),N.push(i),t++}}}(g),q.colTotals)for(var _=k.length;_--;)for(y=p;y<N.length;y++)S=N[y].name,G[S]?G[S]+=parseFloat(k[_][S]||0):G[S]=parseFloat(k[_][S]||0);if(0<l)for(y=0;y<l;y++)N[y].isGroupField&&(A.groupingView.groupField.push(N[y].name),A.groupingView.groupSummary.push(q.groupSummary),A.groupingView.groupSummaryPos.push(q.groupSummaryPos));else A.grouping=!1;A.sortname=N[l].name,A.groupingView.hideFirstGroupCol=!0}),{colModel:N,rows:k,groupOptions:A,groupHeaders:V,summary:G}},jqPivot:function(o,g,u,t){return this.each(function(){var l=this,e=u.regional||"en";function r(e){Q.isFunction(g.onInitPivot)&&g.onInitPivot.call(l),Q.isArray(e)||(e=[]);var r,o,t,n,a=jQuery(l).jqGrid("pivotSetup",e,g),e=0<Q.assocArraySize(a.summary),i=Q.jgrid.from.call(l,a.rows);for(g.ignoreCase&&(i=i.ignoreCase()),r=0;r<a.groupOptions.groupingView.groupField.length;r++)o=g.xDimension[r].sortorder||"asc",t=g.xDimension[r].sorttype||"text",i.orderBy(a.groupOptions.groupingView.groupField[r],o,t,"",t);if(n=g.xDimension.length,u.sortname){for(o=u.sortorder||"asc",t="text",r=0;r<n;r++)if(g.xDimension[r].dataName===u.sortname){t=g.xDimension[r].sorttype||"text";break}i.orderBy(u.sortname,o,t,"",t)}else a.groupOptions.sortname&&n&&(o=g.xDimension[n-1].sortorder||"asc",t=g.xDimension[n-1].sorttype||"text",i.orderBy(a.groupOptions.sortname,o,t,"",t));jQuery(l).jqGrid(Q.extend(!0,{datastr:Q.extend(i.select(),e?{userdata:a.summary}:{}),datatype:"jsonstring",footerrow:e,userDataOnFooter:e,colModel:a.colModel,viewrecords:!0,formatFooterData:!0===g.colTotals,sortname:g.xDimension[0].dataName},a.groupOptions,u||{}));var s=a.groupHeaders;if(s.length)for(r=0;r<s.length;r++)s[r]&&s[r].groupHeaders.length&&jQuery(l).jqGrid("setGroupHeaders",s[r]);g.frozenStaticCols&&jQuery(l).jqGrid("setFrozenColumns"),Q.isFunction(g.onCompletePivot)&&g.onCompletePivot.call(l),g.loadMsg&&Q(".loading_pivot").remove()}void 0===g.loadMsg&&(g.loadMsg=!0),g.loadMsg&&Q("<div class='loading_pivot ui-state-default ui-state-active row'>"+Q.jgrid.getRegional(l,"regional."+e+".defaults.loadtext")+"</div>").insertBefore(l).show(),"string"==typeof o?Q.ajax(Q.extend({url:o,dataType:"json",success:function(e){r(Q.jgrid.getAccessor(e,t&&t.reader?t.reader:"rows"))}},t||{})):r(o)})}})});