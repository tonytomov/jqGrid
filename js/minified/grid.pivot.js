(e=>{"function"==typeof define&&define.amd?define(["jquery","./grid.base","./grid.grouping"],e):e(jQuery)})(function(R){R.assocArraySize=function(e){var r,t=0;for(r in e)e.hasOwnProperty(r)&&t++;return t},R.jgrid.extend({pivotSetup:function(G,e){var z=[],V=[],q=[],Q=[],I=[],Y={grouping:!0,groupingView:{groupField:[],groupSummary:[],groupSummaryPos:[]}},B=[],E=R.extend({rowTotals:!1,rowTotalsText:"Total",colTotals:!1,groupSummary:!0,groupSummaryPos:"header",frozenStaticCols:!1,xMeta:[]},e||{});return this.each(function(){var d,f,p,e,c=this,r=G.length,t=0;function a(e,r,t){e=function(e,r){var t,a,o,n=[];if(!this||"function"!=typeof e||e instanceof RegExp)throw new TypeError;for(o=this.length,t=0;t<o;t++)if(this.hasOwnProperty(t)&&(a=this[t],e.call(r,a,t,this))){n.push(a);break}return n}.call(e,r,t);return 0<e.length?e[0]:null}function o(e,r){var t,a=0,o=!0;for(t in e)if(e.hasOwnProperty(t)){if(e[t]!=this[a]){o=!1;break}if(++a>=this.length)break}return o&&(D=r),o}function n(e,r,t,a){var o,n,i,s,l=r.length,g="",u=[],m=1;for(Array.isArray(t)?(i=t.length,u=t):(i=1,u[0]=t),I=[],n=(Q=[]).root=0;n<i;n++){for(var d,f=[],p=0;p<l;p++){if(s="string"==typeof r[p].aggregator?r[p].aggregator:"cust",null==t)d=o=R.jgrid.trim(r[p].member)+"_"+s,u[0]=r[p].label||s+" "+R.jgrid.trim(r[p].member);else{d=t[n].replace(/\s+/g,"");try{o=1===l?g+d:g+d+"_"+s+"_"+String(p)}catch(e){}u[n]=t[n]}o=isNaN(parseInt(o,10))?o:o+" ","avg"===r[p].aggregator&&(s=-1===D?V.length+"_"+o:D+"_"+o,h[s]?h[s]++:h[s]=1,m=h[s]),a[o]=f[o]=((e,r,t,a,o)=>{var n;if(R.jgrid.isFunction(e))n=e.call(c,r,t,a);else switch(e){case"sum":n=R.jgrid.floatNum(r)+R.jgrid.floatNum(a[t]);break;case"count":""!==r&&null!=r||(r=0),n=a.hasOwnProperty(t)?r+1:0;break;case"min":n=""===r||null==r?R.jgrid.floatNum(a[t]):Math.min(R.jgrid.floatNum(r),R.jgrid.floatNum(a[t]));break;case"max":n=""===r||null==r?R.jgrid.floatNum(a[t]):Math.max(R.jgrid.floatNum(r),R.jgrid.floatNum(a[t]));break;case"avg":n=(R.jgrid.floatNum(r)*(o-1)+R.jgrid.floatNum(a[t]))/o}return n})(r[p].aggregator,a[o],r[p].member,e,m)}g+=t&&null!=t[n]?t[n].replace(/\s+/g,""):"",Q[o]=f,I[o]=u[n]}return a}if(E.rowTotals&&0<E.yDimension.length&&(e=E.yDimension[0].dataName,E.yDimension.splice(0,0,{dataName:e}),E.yDimension[0].converter=function(){return"_r_Totals"}),d=Array.isArray(E.xDimension)?E.xDimension.length:0,f=E.yDimension.length,p=Array.isArray(E.aggregates)?E.aggregates.length:0,0===d||0===p)throw"xDimension or aggregates optiona are not set!";var i,s=[],l=0;for(w=0;w<d;w++)E.xDimension[w].hasOwnProperty("dataName")?(i={name:E.xDimension[w].dataName,frozen:E.frozenStaticCols},null==E.xDimension[w].isGroupField&&(E.xDimension[w].isGroupField=!0),E.xDimension[w].isGroupField&&s.push(E.xDimension[w].dataName),i=R.extend(!0,i,E.xDimension[w]),z.push(i)):l++;d-=l;for(var g,u={},h=[],m=s.length;t<r;){var v=G[t],y=[],x=[],j={},w=0;for(w=0;w<z.length;w++)g=z[w].name,v.hasOwnProperty(g)&&(y.push(R.jgrid.trim(v[g])),j[g]=R.jgrid.trim(v[g]));var b,O=0,D=-1;if(b=a(V,o,y)){if(0<=D){if(O=0,1<=f){for(O=0;O<f;O++)x[O]=R.jgrid.trim(v[E.yDimension[O].dataName]),void 0===x[O]?x[O]=null:E.yDimension[O].converter&&R.jgrid.isFunction(E.yDimension[O].converter)&&(x[O]=E.yDimension[O].converter.call(this,x[O],y,x));b=n(v,E.aggregates,x,b)}else 0===f&&(b=n(v,E.aggregates,null,b));for(w=0;w<E.xMeta.length;w++){var N,P=E.xMeta[w];Object.hasOwn(P,"dataName")&&Object.hasOwn(v,P.dataName)&&(N=Object.hasOwn(P,"separator")?P.separator:", ",b[P.dataName]+=N+v[P.dataName])}V[D]=b}}else{if(O=0,1<=f){for(O=0;O<f;O++)x[O]=R.jgrid.trim(v[E.yDimension[O].dataName]),void 0===x[O]?x[O]=null:E.yDimension[O].converter&&R.jgrid.isFunction(E.yDimension[O].converter)&&(x[O]=E.yDimension[O].converter.call(this,x[O],y,x));j=n(v,E.aggregates,x,j)}else 0===f&&(j=n(v,E.aggregates,null,j));for(w=0;w<E.xMeta.length;w++){var P=E.xMeta[w];Object.hasOwn(P,"dataName")&&Object.hasOwn(v,P.dataName)&&(j[P.dataName]=v[P.dataName]+"")}V.push(j)}var S,T=0,C=null,_=null;for(S in Q)if(Q.hasOwnProperty(S)){if(0===T)C=(u=u.children&&void 0!==u.children?u:{text:S,level:0,children:[],label:S}).children;else{for(_=null,w=0;w<C.length;w++)if(C[w].text===S){_=C[w];break}C=(_||(C.push({children:[],text:S,level:T,fields:Q[S],label:I[S]}),C[C.length-1])).children}T++}t++}var F,h=null,H=[],M=z.length,A=M;if(0<f&&(B[f-1]={useColSpanStyle:!1,groupHeaders:[]}),!function e(r){var t,a,o,n,i;for(o in r)if(r.hasOwnProperty(o)){if("object"!=typeof r[o]){if("level"===o){if(void 0===H[r.level]&&(H[r.level]="",0<r.level)&&-1===r.text.indexOf("_r_Totals")&&(B[r.level-1]={useColSpanStyle:!1,groupHeaders:[]}),H[r.level]!==r.text&&r.children.length&&-1===r.text.indexOf("_r_Totals")&&0<r.level){B[r.level-1].groupHeaders.push({titleText:r.label,numberOfColumns:0});var s=B[r.level-1].groupHeaders.length-1,l=0==s?A:M;if(r.level-1==(E.rowTotals?1:0)&&0<s){for(var g=0,u=0;u<s;u++)g+=B[r.level-1].groupHeaders[u].numberOfColumns;g&&(l=g+d)}z[l]&&(B[r.level-1].groupHeaders[s].startColumnName=z[l].name,B[r.level-1].groupHeaders[s].numberOfColumns=z.length-l),M=z.length}H[r.level]=r.text}if(r.level===f&&"level"===o&&0<f)if(1<p){var m=1;for(t in r.fields)r.fields.hasOwnProperty(t)&&(1===m&&B[f-1].groupHeaders.push({startColumnName:t,numberOfColumns:1,titleText:r.label||r.text}),m++);B[f-1].groupHeaders[B[f-1].groupHeaders.length-1].numberOfColumns=m-1}else B.splice(f-1,1)}if(null!=r[o]&&"object"==typeof r[o]&&e(r[o]),"level"===o&&0<r.level&&(r.level===(0===f?r.level:f)||-1!==H[r.level].indexOf("_r_Totals")))for(t in a=0,r.fields)if(r.fields.hasOwnProperty(t)){for(n in i={},E.aggregates[a])if(E.aggregates[a].hasOwnProperty(n))switch(n){case"member":case"label":case"aggregator":break;default:i[n]=E.aggregates[a][n]}1<p?(i.name=t,i.label=E.aggregates[a].label||r.label):(i.name=r.text,i.label="_r_Totals"===r.text?E.rowTotalsText:r.label),z.push(i),a++}}}(u),E.colTotals)for(var k=V.length;k--;)for(w=d;w<z.length;w++)F=z[w].name,q[F]?q[F]+=R.jgrid.floatNum(V[k][F]):q[F]=R.jgrid.floatNum(V[k][F]);if(0<m){for(w=0;w<m;w++)Y.groupingView.groupField.push(s[w]),Y.groupingView.groupSummary.push(E.groupSummary),Y.groupingView.groupSummaryPos.push(E.groupSummaryPos);Y.sortname=s[w]}else Y.grouping=!1;Y.groupingView.hideFirstGroupCol=!0}),{colModel:z,rows:V,groupOptions:Y,groupHeaders:B,summary:q}},jqPivot:function(t,m,d,a){return this.each(function(){var u=this,e=d.regional||"en";function r(e){R.jgrid.isFunction(m.onInitPivot)&&m.onInitPivot.call(u),Array.isArray(e)||(e=[]);for(var r,t,a,o=[],n=[],i=jQuery(u).jqGrid("pivotSetup",e,m),e=0<R.assocArraySize(i.summary),s=R.jgrid.from.call(u,i.rows),s=m.ignoreCase?s.ignoreCase():s.useCase(),l=0;l<i.groupOptions.groupingView.groupField.length;l++)r=m.xDimension[l].sortorder||"asc",t=m.xDimension[l].sorttype||"text",o.push(i.groupOptions.groupingView.groupField[l]),n.push({so:r,stype:t,scrfmt:"Y-m-d",sfunc:t});if(a=m.xDimension.length,d.sortname){for(r=d.sortorder||"asc",t="text",l=0;l<a;l++)if(m.xDimension[l].dataName===d.sortname){t=m.xDimension[l].sorttype||"text";break}o.push(d.sortname),n.push({so:r,stype:t,srcfmt:"Y-m-d",sfunc:t})}else i.groupOptions.sortname&&a&&(r=m.xDimension[a-1].sortorder||"asc",t=m.xDimension[a-1].sorttype||"text",o.push(i.groupOptions.sortname),n.push({so:r,stype:t,srcfmt:"Y-m-d",sfunc:t}));o.length&&s.orderBy(o,n),jQuery(u).jqGrid(R.extend(!0,{datastr:R.extend(s.select(),e?{userdata:i.summary}:{}),datatype:"jsonstring",footerrow:e,userDataOnFooter:e,colModel:i.colModel,viewrecords:!0,formatFooterData:!0===m.colTotals,sortname:m.xDimension[0].dataName},i.groupOptions,d||{}));var g=i.groupHeaders;if(g.length)for(l=0;l<g.length;l++)g[l]&&g[l].groupHeaders.length&&jQuery(u).jqGrid("setGroupHeaders",g[l]);m.frozenStaticCols&&jQuery(u).jqGrid("setFrozenColumns"),R.jgrid.isFunction(m.onCompletePivot)&&m.onCompletePivot.call(u),m.loadMsg&&R(".loading_pivot").remove()}void 0===m.loadMsg&&(m.loadMsg=!0),m.loadMsg&&R("<div class='loading_pivot ui-state-default ui-state-active row'>"+R.jgrid.getRegional(u,"regional."+e+".defaults.loadtext")+"</div>").insertBefore(u).show(),"string"==typeof t?R.ajax(R.extend({url:t,dataType:"json",success:function(e){r(R.jgrid.getAccessor(e,a&&a.reader?a.reader:"rows"))}},a||{})):r(t)})}})});