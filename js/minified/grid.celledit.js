!function(e){"use strict";"function"==typeof define&&define.amd?define(["jquery","./grid.base"],e):e(jQuery)}(function(G){"use strict";G.jgrid.extend({editCell:function(c,f,u,g,C){return this.each(function(){var e,i,l,t,r=this,o=G(this).jqGrid("getStyleUI",r.p.styleUI+".common","highlight",!0),d=r.p.ariaBody?"":G(this).jqGrid("getStyleUI",r.p.styleUI+".common","hover",!0),s=G(this).jqGrid("getStyleUI",r.p.styleUI+".celledit","inputClass",!0),a=G(this).jqGrid("getStyleUI",r.p.styleUI+".celledit","selectClass",!0);if(r.grid&&!0===r.p.cellEdit){if(f=parseInt(f,10),r.p.selrow=r.rows[c].id,r.p.knv||r.p.ariaBody||G(r).jqGrid("GridNav"),0<r.p.savedRow.length){if(!0===u&&c==r.p.iRow&&f==r.p.iCol)return;G(r).jqGrid("saveCell",r.p.savedRow[0].id,r.p.savedRow[0].ic)}else window.setTimeout(function(){G("#"+G.jgrid.jqID(r.p.knv)).attr("tabindex","-1").focus()},1);if("subgrid"!==(e=(t=r.p.colModel[f]).name)&&"cb"!==e&&"rn"!==e&&"sc"!==e){try{l=G(r.rows[c].cells[f])}catch(e){l=G("td",r.rows[c]).eq(f)}if(0<=parseInt(r.p.iCol,10)&&0<=parseInt(r.p.iRow,10)&&void 0!==r.p.iRowId&&(n=G(r).jqGrid("getGridRowById",r.p.iRowId),G(n).removeClass("selected-row "+d).find("td").eq(r.p.iCol).removeClass("edit-cell "+o)),l.addClass("edit-cell "+o),G(r.rows[c]).addClass("selected-row "+d),!0!==t.editable||!0!==u||l.hasClass("not-editable-cell")||G.jgrid.isFunction(r.p.isCellEditable)&&!r.p.isCellEditable.call(r,e,c,f))i=l.html().replace(/\&#160\;/gi,""),G(r).triggerHandler("jqGridCellSelect",[r.rows[c].id,f,i,g]),G.jgrid.isFunction(r.p.onCellSelect)&&r.p.onCellSelect.call(r,r.rows[c].id,f,i,g);else{try{i=G.unformat.call(r,l,{rowId:r.rows[c].id,colModel:t},f)}catch(e){i=t.edittype&&"textarea"===t.edittype?l.text():l.html()}r.p.autoencode&&(i=G.jgrid.htmlDecode(i)),t.edittype||(t.edittype="text"),r.p.savedRow.push({id:c,ic:f,name:e,v:i,rowId:r.rows[c].id});try{("&nbsp;"===i||"&#160;"===i||1===i.length&&160===i.charCodeAt(0))&&(i="")}catch(e){}G.jgrid.isFunction(r.p.formatCell)&&void 0!==(n=r.p.formatCell.call(r,r.rows[c].id,e,i,c,f))&&(i=n),G(r).triggerHandler("jqGridBeforeEditCell",[r.rows[c].id,e,i,c,f]),G.jgrid.isFunction(r.p.beforeEditCell)&&r.p.beforeEditCell.call(r,r.rows[c].id,e,i,c,f);var n,o=G.extend({},t.editoptions||{},{id:c+"_"+e,name:e,rowId:r.rows[c].id,oper:"edit",module:"cell"}),p=(C&&(i=g.key),G.jgrid.createEl.call(r,t.edittype,o,i,!0,G.extend({},G.jgrid.ajaxOptions,r.p.ajaxSelectOptions||{})));-1<G.inArray(t.edittype,["text","textarea","password"])?G(p).addClass(s):"select"===t.edittype&&G(p).addClass(a),l.html("").append(p).attr("tabindex","0"),G.jgrid.bindEv.call(r,p,o),window.setTimeout(function(){G(p).focus()},1),G("input, select, textarea",l).on("keydown",function(e){var i=e.key;if(27===e.keyCode&&(!(0<G("input.hasDatepicker",l).length)||G(".ui-datepicker").is(":hidden")?G(r).jqGrid("restoreCell",c,f):G("input.hasDatepicker",l).datepicker("hide")),13===e.keyCode&&e.altKey&&"TEXTAREA"===this.nodeName)return this.value=this.value+"\r",!0;if(13===e.keyCode&&!e.shiftKey)return G(r).jqGrid("saveCell",c,f),c<r.rows.length-1&&C?G(r).jqGrid("focusBodyCell",c+1,f):setTimeout(function(){G(r).jqGrid("focusBodyCell",c,f)},100),!1;if(9===e.keyCode&&!C){if(r.grid.hDiv.loading)return!1;e.shiftKey?r.p.ariaBody?(G(r).jqGrid("saveCell",c,f),1<f&&G(r).jqGrid("focusBodyCell",c,f-1)):!G(r).jqGrid("prevCell",c,f,e)&&r.p.editNextRowCell&&0<c-1&&r.rows[c-1]&&(c--,G(r).jqGrid("prevCell",c,r.p.colModel.length,e)):r.p.ariaBody?(G(r).jqGrid("saveCell",c,f),f<r.p.colModel.length-1&&G(r).jqGrid("focusBodyCell",c,f+1)):!G(r).jqGrid("nextCell",c,f,e)&&r.p.editNextRowCell&&r.rows[c+1]&&(c++,G(r).jqGrid("nextCell",c,0,e))}!C&&r.p.F2key&&r.p.ariaBody&&"F2"===e.key&&(G(r).jqGrid("saveCell",c,f),G(r).jqGrid("focusBodyCell",c,f),r.p.F2key=!1),C&&("ArrowUp"===i&&(G(r).jqGrid("saveCell",c,f),1<c)&&G(r).jqGrid("focusBodyCell",c-1,f),"ArrowDown"===i&&(G(r).jqGrid("saveCell",c,f),c<r.p.rows.length-1)&&G(r).jqGrid("focusBodyCell",c+1,f),"ArrowLeft"===i&&(G(r).jqGrid("saveCell",c,f),1<f)&&G(r).jqGrid("focusBodyCell",c,f-1),"ArrowRight"===i&&(G(r).jqGrid("saveCell",c,f),f<r.p.colModel.length-1)&&G(r).jqGrid("focusBodyCell",c,f+1),9===e.keyCode)&&(G(r).jqGrid("saveCell",c,f),e.shiftKey?1<f&&G(r).jqGrid("focusBodyCell",c,f-1):f<r.p.colModel.length-1&&G(r).jqGrid("focusBodyCell",c,f+1)),e.stopPropagation()}),G(r).triggerHandler("jqGridAfterEditCell",[r.rows[c].id,e,i,c,f]),G.jgrid.isFunction(r.p.afterEditCell)&&r.p.afterEditCell.call(r,r.rows[c].id,e,i,c,f)}r.p.iCol=f,r.p.iRow=c,r.p.iRowId=r.rows[c].id}}})},saveCell:function(q,b,m){return this.each(function(){var r=this,e=r.p.colModel[b],o=e.name,d=G(r).jqGrid("getGridRowById",r.rows[q].id),s=G("td",d).eq(b),a=(void 0!==m&&(t=G.unformat.call(r,s,{rowId:r.rows[q].id,colModel:e},b),r.p.savedRow.push({id:q,ic:b,name:o,v:t,rowId:r.rows[q].id}),r.p.savedValues={oldvalue:t,newvalue:m,indexRow:q}),1<=r.p.savedRow.length?0:null),n=G.jgrid.getRegional(this,"errors"),p=G.jgrid.getRegional(this,"edit");if(r.grid&&!0===r.p.cellEdit){if(null!==a){var c=G.jgrid.jqID(o),f=G(s).offset();if(void 0===m)switch(e.edittype){case"select":var l,u,g=e.editoptions.multiple?(i=G("#"+q+"_"+c,d),l=[],(u=G(i).val())?u.join(","):u="",G("option:selected",i).each(function(e,i){l[e]=G(i).text()}),l.join(",")):(u=G("#"+q+"_"+c+" option:selected",d).val(),G("#"+q+"_"+c+" option:selected",d).text());e.formatter&&(g=u);break;case"checkbox":var i=["Yes","No"];e.editoptions&&e.editoptions.value&&(i=e.editoptions.value.split(":")),u=G("#"+q+"_"+c,d).is(":checked")?i[0]:i[1],g=u;break;case"password":case"text":case"textarea":case"button":u=G("#"+q+"_"+c,d).val(),g=u;break;case"custom":try{if(!e.editoptions||!G.jgrid.isFunction(e.editoptions.custom_value))throw"e1";if(void 0===(u=e.editoptions.custom_value.call(r,G(".customelement",s),"get")))throw"e2";g=u}catch(e){"e1"===e?G.jgrid.info_dialog(n.errcap,"function 'custom_value' "+p.msg.nodefined,p.bClose,{styleUI:r.p.styleUI}):"e2"===e?G.jgrid.info_dialog(n.errcap,"function 'custom_value' "+p.msg.novalue,p.bClose,{styleUI:r.p.styleUI}):G.jgrid.info_dialog(n.errcap,e.message,p.bClose,{styleUI:r.p.styleUI})}}else{if(!0!==e.editable||s.hasClass("not-editable-cell")||G.jgrid.isFunction(r.p.isCellEditable)&&!r.p.isCellEditable.call(r,o,q,b))return g=u=m,void r.p.savedRow.splice(0,1);g=u=m}if(g!==r.p.savedRow[a].v){var t=G(r).triggerHandler("jqGridBeforeSaveCell",[r.p.savedRow[a].rowId,o,u,q,b]),C=(t&&(g=u=t),G.jgrid.isFunction(r.p.beforeSaveCell)&&(t=r.p.beforeSaveCell.call(r,r.p.savedRow[a].rowId,o,u,q,b))&&(g=u=t),G.jgrid.checkValues.call(r,u,b)),v=!1;if(!0===C[0]){var t=G(r).triggerHandler("jqGridBeforeSubmitCell",[r.p.savedRow[a].rowId,o,u,q,b])||{},w=(G.jgrid.isFunction(r.p.beforeSubmitCell)&&(t=(t=r.p.beforeSubmitCell.call(r,r.p.savedRow[a].rowId,o,u,q,b))||{}),G(r).triggerHandler("jqGridOnSubmitCell",[r.p.savedRow[a].rowId,o,u,q,b]));if(void 0===w&&(w=!0),!1===(w=G.jgrid.isFunction(r.p.onSubmitCell)&&void 0===(w=r.p.onSubmitCell(r.p.savedRow[a].rowId,o,u,q,b))?!0:w))return;0<G("input.hasDatepicker",s).length&&G("input.hasDatepicker",s).datepicker("hide");var h={};if("remote"===r.p.cellsubmit)if(r.p.cellurl){r.p.autoencode&&(u=G.jgrid.htmlEncode(u)),e.editoptions&&e.editoptions.NullIfEmpty&&""===u&&(u="null",v=!0),h[o]=u;var w=r.p.prmNames,j=w.id,y=w.oper;h[j]=G.jgrid.stripPref(r.p.idPrefix,r.p.savedRow[a].rowId),h[y]=w.editoper,h=G.extend(t,h),G(r).jqGrid("progressBar",{method:"show",loadtype:r.p.loadui,htmlcontent:G.jgrid.getRegional(r,"defaults.savetext")}),r.grid.hDiv.loading=!0,G.ajax(G.extend({url:r.p.cellurl,data:G.jgrid.isFunction(r.p.serializeCellData)?r.p.serializeCellData.call(r,h,o):h,type:"POST",success:function(e,i,l){var t;G(r).jqGrid("progressBar",{method:"hide",loadtype:r.p.loadui}),r.grid.hDiv.loading=!1,"success"===i&&(!0===(t=!0===(t=G(r).triggerHandler("jqGridAfterSubmitCell",[r,l,h[j],o,u,q,b])||[!0,""])[0]&&G.jgrid.isFunction(r.p.afterSubmitCell)?r.p.afterSubmitCell.call(r,l,h[j],o,u,q,b):t)[0]?(v&&(u=""),G(s).empty(),G(r).jqGrid("setCell",r.p.savedRow[a].rowId,b,g,!1,!1,!0),s=G("td",d).eq(b),G(s).addClass("dirty-cell"),G(d).addClass("edited"),G(r).triggerHandler("jqGridAfterSaveCell",[r.p.savedRow[a].rowId,o,u,q,b]),G.jgrid.isFunction(r.p.afterSaveCell)&&r.p.afterSaveCell.call(r,r.p.savedRow[a].rowId,o,u,q,b),r.p.savedRow.splice(0,1)):(G(r).triggerHandler("jqGridErrorCell",[l,i]),G.jgrid.isFunction(r.p.errorCell)?r.p.errorCell.call(r,l,i):G.jgrid.info_dialog(n.errcap,t[1],p.bClose,{styleUI:r.p.styleUI,top:f.top+30,left:f.left,onClose:function(){r.p.restoreCellonFail||G("#"+q+"_"+c,d).focus()}}),r.p.restoreCellonFail&&G(r).jqGrid("restoreCell",q,b)))},error:function(e,i,l){G("#lui_"+G.jgrid.jqID(r.p.id)).hide(),r.grid.hDiv.loading=!1,G(r).triggerHandler("jqGridErrorCell",[e,i,l]),G.jgrid.isFunction(r.p.errorCell)?r.p.errorCell.call(r,e,i,l):G.jgrid.info_dialog(n.errcap,e.status+" : "+e.statusText+"<br/>"+i,p.bClose,{styleUI:r.p.styleUI,top:f.top+30,left:f.left,onClose:function(){r.p.restoreCellonFail||G("#"+q+"_"+c,d).focus()}}),r.p.restoreCellonFail&&G(r).jqGrid("restoreCell",q,b)}},G.jgrid.ajaxOptions,r.p.ajaxCellOptions||{}))}else try{G.jgrid.info_dialog(n.errcap,n.nourl,p.bClose,{styleUI:r.p.styleUI}),r.p.restoreCellonFail&&G(r).jqGrid("restoreCell",q,b)}catch(e){}"clientArray"===r.p.cellsubmit?(G(s).empty(),G(r).jqGrid("setCell",r.p.savedRow[a].rowId,b,g,!1,!1,!0),s=G("td",d).eq(b),G(s).addClass("dirty-cell"),G(d).addClass("edited"),G(r).triggerHandler("jqGridAfterSaveCell",[r.p.savedRow[a].rowId,o,u,q,b]),G.jgrid.isFunction(r.p.afterSaveCell)&&r.p.afterSaveCell.call(r,r.p.savedRow[a].rowId,o,u,q,b),r.p.savedRow.splice(0,1)):"storage"===r.p.cellsubmit&&((h=r.p.savedRow[a])[o]=u,h[r.p.keyName]=G.jgrid.stripPref(r.p.idPrefix,r.p.savedRow[a].rowId),G(r).jqGrid("updateStorageRecord",h).then(function(e){"complete"===e.type&&(G(s).empty(),G(r).jqGrid("setCell",r.p.savedRow[a].rowId,b,g,!1,!1,!0),s=G("td",d).eq(b),G(s).addClass("dirty-cell"),G(d).addClass("edited"),G(r).triggerHandler("jqGridAfterSaveCell",[r.p.savedRow[a].rowId,o,u,q,b]),G.jgrid.isFunction(r.p.afterSaveCell)&&r.p.afterSaveCell.call(r,r.p.savedRow[a].rowId,o,u,q,b),r.p.savedRow.splice(0,1))}).catch(function(e){G.jgrid.info_dialog("Error",e.target.error.name+" : "+e.target.error.message,"Close")}))}else try{G.jgrid.isFunction(r.p.validationCell)?r.p.validationCell.call(r,G("#"+q+"_"+c,d),C[1],q,b):(window.setTimeout(function(){G.jgrid.info_dialog(n.errcap,u+" "+C[1],p.bClose,{styleUI:r.p.styleUI,top:f.top+30,left:f.left,onClose:function(){r.p.restoreCellonFail||G("#"+q+"_"+c,d).focus()}})},50),r.p.restoreCellonFail&&G(r).jqGrid("restoreCell",q,b))}catch(e){alert(C[1])}}else G(r).jqGrid("restoreCell",q,b)}window.setTimeout(function(){G("#"+G.jgrid.jqID(r.p.knv)).attr("tabindex","-1").focus(),r.p.ariaBody&&G(r).jqGrid("focusBodyCell",r.p.iRow,r.p.iCol)},0)}})},restoreCell:function(t,r){return this.each(function(){var e=this,i=1<=e.p.savedRow.length?0:null;if(e.grid&&!0===e.p.cellEdit){if(null!==i){var l=G(e).jqGrid("getGridRowById",e.p.savedRow[i].rowId),l=G("td",l).eq(r);if(G.jgrid.isFunction(G.fn.datepicker))try{G("input.hasDatepicker",l).datepicker("hide")}catch(e){}G(l).empty().attr("tabindex","-1"),G(e).jqGrid("setCell",e.p.savedRow[0].rowId,r,e.p.savedRow[i].v,!1,!1,!0),G(e).triggerHandler("jqGridAfterRestoreCell",[e.p.savedRow[i].rowId,e.p.savedRow[i].v,t,r]),G.jgrid.isFunction(e.p.afterRestoreCell)&&e.p.afterRestoreCell.call(e,e.p.savedRow[i].rowId,e.p.savedRow[i].v,t,r),e.p.savedRow.splice(0,1)}window.setTimeout(function(){G("#"+e.p.knv).attr("tabindex","-1").focus(),e.p.ariaBody&&G(e).jqGrid("focusBodyCell",e.p.iRow,e.p.iCol)},0)}})},nextCell:function(t,r,o){var d;return this.each(function(){var e,i=this,l=!1;if(i.grid&&!0===i.p.cellEdit){for(e=r+1;e<i.p.colModel.length;e++)if(!0===i.p.colModel[e].editable&&(!G.jgrid.isFunction(i.p.isCellEditable)||i.p.isCellEditable.call(i,i.p.colModel[e].name,t,e))){l=e;break}!1!==l?(d=!0,G(i).jqGrid("editCell",t,l,!0,o)):(d=!1,0<i.p.savedRow.length&&G(i).jqGrid("saveCell",t,r))}}),d},prevCell:function(t,r,o){var d;return this.each(function(){var e,i=this,l=!1;if(!i.grid||!0!==i.p.cellEdit)return!1;for(e=r-1;0<=e;e--)if(!0===i.p.colModel[e].editable&&(!G.jgrid.isFunction(i.p.isCellEditable)||i.p.isCellEditable.call(i,i.p.colModel[e].name,t,e))){l=e;break}!1!==l?(d=!0,G(i).jqGrid("editCell",t,l,!0,o)):(d=!1,0<i.p.savedRow.length&&G(i).jqGrid("saveCell",t,r))}),d},GridNav:function(){return this.each(function(){var e,i,l,s=this;function t(e,i,l){var t,r,o,d;"v"===l.substr(0,1)&&(t=G(s.grid.bDiv)[0].clientHeight,d=G(s.grid.bDiv)[0].scrollTop,r=s.rows[e].offsetTop+s.rows[e].clientHeight,o=s.rows[e].offsetTop,"vd"===l&&t<=r&&(G(s.grid.bDiv)[0].scrollTop=G(s.grid.bDiv)[0].scrollTop+s.rows[e].clientHeight),"vu"===l)&&o<d&&(G(s.grid.bDiv)[0].scrollTop=G(s.grid.bDiv)[0].scrollTop-s.rows[e].clientHeight),"h"===l&&(t=G(s.grid.bDiv)[0].clientWidth,r=G(s.grid.bDiv)[0].scrollLeft,o=s.rows[e].cells[i].offsetLeft+s.rows[e].cells[i].clientWidth,d=s.rows[e].cells[i].offsetLeft,o>=t+parseInt(r,10)?G(s.grid.bDiv)[0].scrollLeft=G(s.grid.bDiv)[0].scrollLeft+s.rows[e].cells[i].clientWidth:d<r&&(G(s.grid.bDiv)[0].scrollLeft=G(s.grid.bDiv)[0].scrollLeft-s.rows[e].cells[i].clientWidth))}function r(e,i){var l,t;if("lft"===i)for(l=e+1,t=e;0<=t;t--)if(!0!==s.p.colModel[t].hidden){l=t;break}if("rgt"===i)for(l=e-1,t=e;t<s.p.colModel.length;t++)if(!0!==s.p.colModel[t].hidden){l=t;break}return l}s.grid&&!0===s.p.cellEdit&&(s.p.knv=s.p.id+"_kn",e=G("<div style='position:fixed;top:0px;width:1px;height:1px;' tabindex='0'><div tabindex='-1' style='width:1px;height:1px;' id='"+s.p.knv+"'></div></div>"),G(e).insertBefore(s.grid.cDiv),G("#"+s.p.knv).focus().keydown(function(e){switch(l=e.keyCode,"rtl"===s.p.direction&&(37===l?l=39:39===l&&(l=37)),l){case 38:0<s.p.iRow-1&&(t(s.p.iRow-1,s.p.iCol,"vu"),G(s).jqGrid("editCell",s.p.iRow-1,s.p.iCol,!1,e));break;case 40:s.p.iRow+1<=s.rows.length-1&&(t(s.p.iRow+1,s.p.iCol,"vd"),G(s).jqGrid("editCell",s.p.iRow+1,s.p.iCol,!1,e));break;case 37:0<=s.p.iCol-1&&(i=r(s.p.iCol-1,"lft"),t(s.p.iRow,i,"h"),G(s).jqGrid("editCell",s.p.iRow,i,!1,e));break;case 39:s.p.iCol+1<=s.p.colModel.length-1&&(i=r(s.p.iCol+1,"rgt"),t(s.p.iRow,i,"h"),G(s).jqGrid("editCell",s.p.iRow,i,!1,e));break;case 13:0<=parseInt(s.p.iCol,10)&&0<=parseInt(s.p.iRow,10)&&G(s).jqGrid("editCell",s.p.iRow,s.p.iCol,!0,e);break;default:return!0}return!1}))})},getChangedCells:function(o){var e=[];return o=o||"all",this.each(function(){var t,r=this;r.grid&&!0===r.p.cellEdit&&G(r.rows).each(function(i){var l={};G(this).hasClass("edited")&&(G("td",this).each(function(e){if("cb"!==(t=r.p.colModel[e].name)&&"subgrid"!==t&&"sc"!==t)if("dirty"===o){if(G(this).hasClass("dirty-cell"))try{l[t]=G.unformat.call(r,this,{rowId:r.rows[i].id,colModel:r.p.colModel[e]},e)}catch(e){l[t]=G.jgrid.htmlDecode(G(this).html())}}else try{l[t]=G.unformat.call(r,this,{rowId:r.rows[i].id,colModel:r.p.colModel[e]},e)}catch(e){l[t]=G.jgrid.htmlDecode(G(this).html())}}),l.id=this.id,e.push(l))})}),e}})});